@using BhuInfo.Data.Factory.BusinessFactory
@using BhuInfo.Data.Objects.Entities
@using BhuInfo.Data.Service.DateTimeHelper
@using BhuInfo.Data.Service.Enums
@using BhuInfo.Data.Service.TextFormatter
@model BhuInfo.Data.Objects.Entities.News

@{

    Session["newsmodel"] = null;
    var newsList = new NewsDataFactory().GetAllNews();
    var orderNews = newsList.OrderByDescending(n => n.DateCreated);
    var countedNews = orderNews.Take(4);
    var news = countedNews.ToList();

    var allNewsList = new NewsDataFactory().GetTopNthPopularNews(4);
    var popularNews = allNewsList.ToList();
    var newsId = Model.NewsId;

    var newsComments = new NewsCommentFactory().GetNewsComments((int) newsId);

    var postedBy = new AppUserFactory().GetAppUserById((int) Model.CreatedById);
    if (postedBy == null)
    {
        new HttpNotFoundResult();
        return;
    }

    var discussions = new SchoolDiscussionDataFactory().GetAllDiscussions();
    var orderDiscussions = discussions.OrderByDescending(n => n.DiscussionView);
    var countedDiscussions = orderDiscussions.Take(5);
    var loggedinuser = Session["bhuinfologgedinuser"] as AppUser;
}

@{
    ViewBag.Title = "NewsDetails";
}
@{
    var enumerable = newsComments as IList<NewsComment> ?? newsComments.ToList();
}
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container">
<div class="content">
<div class="single-page">
<div class="print-main">
    <h3>@Html.DisplayFor(model => model.NewsCategory.Name)</h3>
    <a href="#" style="font-weight: bolder">@Html.DisplayFor(model => model.Title)</a>
    <p class="sub_head">
        Posted by <a href="#">@postedBy.DisplayName</a> @(new DateTimeCalculator().TimeAgo(Model.DateCreated))
    </p>
    @if ((Model.Image != null) && (Model.SecondImage != null) && (Model.ThirdImage != null))
    {
        <div id="myCarousel" class="carousel slide" data-ride="carousel">
            <!-- Indicators -->
            <ol class="carousel-indicators">
                <li data-target="#myCarousel" data-slide-to="0" class=""></li>
                <li data-target="#myCarousel" data-slide-to="1" class="active"></li>
                <li data-target="#myCarousel" data-slide-to="2" class=""></li>
            </ol>
            <div class="carousel-inner" role="listbox">
                <div class="item active left">
                    <img height="40" width="40" class="img-responsive" src="../../UploadedFiles/@UploadType.NewsImage/@Model.Image" alt="First slide">

                </div>
                <div class="item next left">
                    <img height="40" width="40" class="img-responsive" src="../../UploadedFiles/@UploadType.NewsImage/@Model.SecondImage" alt="Second slide">

                </div>
                <div class="item">
                    <img height="40" width="40" class="img-responsive" src="../../UploadedFiles/@UploadType.NewsImage/@Model.ThirdImage" alt="Third slide">

                </div>
            </div>
            <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
                <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
                <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
        </div>
    }
    @if ((Model.Image != null) && (Model.SecondImage == null) && (Model.ThirdImage != null))
    {
        <div id="myCarousel" class="carousel slide" data-ride="carousel">
            <!-- Indicators -->
            <ol class="carousel-indicators">
                <li data-target="#myCarousel" data-slide-to="0" class=""></li>
                <li data-target="#myCarousel" data-slide-to="2" class=""></li>
            </ol>
            <div class="carousel-inner" role="listbox">
                <div class="item active left">
                    <img height="40" width="40" class="img-responsive" src="../../UploadedFiles/@UploadType.NewsImage/@Model.Image" alt="First slide">

                </div>
                <div class="item">
                    <img height="40" width="40" class="img-responsive" src="../../UploadedFiles/@UploadType.NewsImage/@Model.ThirdImage" alt="Third slide">

                </div>
            </div>
            <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
                <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
                <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
        </div>
    }
    @if ((Model.Image != null) && (Model.SecondImage != null) && (Model.ThirdImage == null))
    {
        <div id="myCarousel" class="carousel slide" data-ride="carousel">
            <!-- Indicators -->
            <ol class="carousel-indicators">
                <li data-target="#myCarousel" data-slide-to="0" class=""></li>
                <li data-target="#myCarousel" data-slide-to="1" class="active"></li>
            </ol>
            <div class="carousel-inner" role="listbox">
                <div class="item active left">
                    <img height="40" width="40" class="img-responsive" src="../../UploadedFiles/@UploadType.NewsImage/@Model.Image" alt="First slide">

                </div>
                <div class="item next left">
                    <img height="40" width="40" class="img-responsive" src="../../UploadedFiles/@UploadType.NewsImage/@Model.SecondImage" alt="Second slide">

                </div>
            </div>
            <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
                <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
                <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
        </div>
    }
    @if ((Model.Image != null) && (Model.SecondImage == null) && (Model.ThirdImage == null))
    {
        <img height="40" width="40" class="img-responsive" src="../../UploadedFiles/@UploadType.NewsImage/@Model.Image" alt="">
    }

    <p class="ptext">
        @(new RemoveCharacters().RemoveSpecialCharacters(Model.Content))
    </p>
    <label id="likeOrDislikeDiv">
        @{
            @Html.Partial("_LikeOrDislikePartial", Model)
            ;
        }
    </label><br/>
    @if (loggedinuser != null)
    {
        <div id="likedislikeinfo">
            @{
                @Html.Partial("_LikeDislikeInfo", Model)
            }
        </div>
    }

</div>
<div class="col-md-7 single-content-left">
    <div class="features-list">
        <h3>Trending Discussion Topics</h3>
        <ul>
            @foreach (var item in countedDiscussions)
            {
                <li style="font-weight: bold">
                    <a href="@Url.Action("Activity", "SchoolDiscussions", new {Id = item.SchoolDiscussionId})">@item.Topic</a>
                </li>
            }
        </ul>
    </div>
    <div class="single">
        <div class="leave">
            @if (enumerable.Count > 0)
            {
                <h4>Leave a Comment</h4>
            }
            else
            {
                <h4 class="alert alert-info">Be the first to comment</h4>
            }
        </div>
        @if (TempData["news"] != null)
        {
            if (TempData["notificationtype"].Equals(NotificationType.Success.ToString()))
            {
                <p class="alert-success alert-dismissable" style="height: 30px">@TempData["news"]</p>
            }
            else if (TempData["notificationtype"].Equals(NotificationType.Danger.ToString()))
            {
                <p class="alert-danger alert-dismissable" style="height: 30px">@TempData["news"]</p>
            }
            else if (TempData["notificationtype"].Equals(NotificationType.Info.ToString()))
            {
                <p class="alert-info alert-dismissable" style="height: 30px">@TempData["news"]</p>
            }
        }
        @if (loggedinuser != null)
        {
            using (Ajax.BeginForm("CreateNewsComment", "News",
                new AjaxOptions
                {
                    HttpMethod = "Post",
                    UpdateTargetId = "commentDiv", OnSuccess = "OnSuccess"
                }, null, new {id = "commentForm"}))
            {
                @Html.AntiForgeryToken()
                @Html.ValidationSummary(true, "", new {@class = "text-danger"})
                @Html.Hidden("NewsId", Model.NewsId)
                <div class="form-group col-md-12">
                    @Html.Label("Comment", null, new {@class = "control-label"})
                    @Html.TextArea("Comment", null, new {@class = "form-control", id = "commentText"})
                    @Html.ValidationMessageFor(model => model.NewComments.Single().Comment, "", new {@class = "text-danger"})
                </div>

                <div class="col-md-12">
                    <input type="submit" value="submit" id="submitComment" class="btn btn-primary btn-sm pull-right"/>

                </div>
            }
        }
        else
        {
            Session["newsmodel"] = Model;
            <label>Please <a href="@Url.Action("Login", "Account", new {Id = Model.NewsId})" style="color: blue"> Sign In</a> to comment on this article</label>
        }
        <div class="comments1" id="commentDiv">
            @{
                Html.RenderPartial("SubComment", Model);
            }

        </div>
        @if (enumerable.Count > 7)
        {
            var number = enumerable.Count - 7;
            <a style="font-weight: bold" id="btnLoadMore">Load @number more comments</a>
        }
        <div class="comments1" id="commentMoreDiv">
            @{
                Html.RenderPartial("Comment", Model);
            }


        </div>
    </div>
</div>
<div class="col-md-5 content-right content-right-top">
    <h5 class="head">Recent News</h5>
    @foreach (var item in news)
    {
        <a href="@Url.Action("ViewNewsDetails", "Home", new {Id = item.NewsId})">
            <div class="editor text-center">

                <h3>@item.Title</h3>
                @if (item.Content.Length > 40)
                {
                    <p>@(new RemoveCharacters().RemoveSpecialCharacters(item.Content).Substring(0, 80) + "...")</p>
                }
                else
                {
                    <p>@(new RemoveCharacters().RemoveSpecialCharacters(item.Content))</p>
                }
                <label style="font-weight: bold">@(new DateTimeCalculator().TimeAgo(item.DateCreated))</label>
                <br/>
                <label style="color: black"> @(new DateTimeCalculator().CommentAndViews(item)) </label>
                <br/>
                @if ((item.Likes > 1) && (item.Dislikes > 1))
                {
                    <label>
                        <label style="color: green">@item.Likes Likes</label> <label style="color: red">@item.Dislikes Dislikes</label>
                    </label>
                }
                @if ((item.Likes <= 1) && (item.Dislikes <= 1))
                {
                    <label>
                        <label style="color: green">@item.Likes Like</label> <label style="color: red">@item.Dislikes Dislike</label>
                    </label>
                }
                @if ((item.Likes <= 1) && (item.Dislikes > 1))
                {
                    <label>
                        <label style="color: green">@item.Likes Like</label> <label style="color: red">@item.Dislikes Dislikes</label>
                    </label>
                }
                @if ((item.Likes > 1) && (item.Dislikes <= 1))
                {
                    <label>
                        <label style="color: green">@item.Likes Likes</label> <label style="color: red">@item.Dislikes Dislike</label>
                    </label>
                }
                <br/>
                <span></span>

            </div>
        </a>
    }


    <div class="editors-pic-grids" id="popular">

        <h5>Popular News</h5>
        @foreach (var item in popularNews)
        {
            <div class="editors-pic">
                <div class="e-pic">
                    <a href="@Url.Action("ViewNewsDetails", "Home", new {Id = item.NewsId})">
                        <img src="~/UploadedFiles/@UploadType.NewsImage/@item.Image" alt=""/>
                    </a>
                </div>
                <div class="e-pic-info">
                    <a href="@Url.Action("ViewNewsDetails", "Home", new {Id = item.NewsId})">@item.Title</a>
                    <span></span>
                    <label>@(new DateTimeCalculator().TimeAgo(item.DateCreated))</label><br/>
                    <label style="color: black"> @(new DateTimeCalculator().CommentAndViews(item)) </label>
                    <br/>

                    @if ((item.Likes > 1) && (item.Dislikes > 1))
                    {
                        <label>
                            <label style="color: green">@item.Likes Likes</label> <label style="color: red">@item.Dislikes Dislikes</label>
                        </label>
                    }
                    @if ((item.Likes <= 1) && (item.Dislikes <= 1))
                    {
                        <label>
                            <label style="color: green">@item.Likes Like</label> <label style="color: red">@item.Dislikes Dislike</label>
                        </label>
                    }
                    @if ((item.Likes <= 1) && (item.Dislikes > 1))
                    {
                        <label>
                            <label style="color: green">@item.Likes Like</label> <label style="color: red">@item.Dislikes Dislikes</label>
                        </label>
                    }
                    @if ((item.Likes > 1) && (item.Dislikes <= 1))
                    {
                        <label>
                            <label style="color: green">@item.Likes Likes</label> <label style="color: red">@item.Dislikes Dislike</label>
                        </label>
                    }
                    <br/>
                </div>
                <div class="clearfix"></div>
            </div>
        }

        <div class="clearfix"></div>
    </div>
</div>
<div class="clearfix"></div>
</div>
</div>
@section Scripts
{
    <script type="text/javascript">
        $(document)
            .ready(function() {
                var that = $('#btnLoadMore');
                that.click(function() {
                    that.data('clicked', true);


                    if (that.data('clicked')) {

                        console.log(that.data('clicked'));
                        $('#btnLoadMore').hide();
                        $('#commentDiv').hide();
                        $(function() {
                            setInterval(function() {
                                    $('#likeOrDislikeDiv')
                                        .hide()
                                        .load('@Url.Action("ReloadLikeDislikePartial", "Home", new {Id = Model.NewsId})')
                                        .fadeIn(0.5);
                                    $('#likedislikeinfo')
                                        .hide()
                                        .load('@Url.Action("ReloadLikeDislikeInfo", "Home", new {Id = Model.NewsId})')
                                        .fadeIn(0.5);
                                    $('#commentMoreDiv')
                                        .hide()
                                        .load('@Url.Action("ReloadCompleteView", "Home", new {Id = Model.NewsId})')
                                        .fadeIn(1);
                                },
                                2000);
                        });
                    }else if(that.data('clicked') !== true) {
                        $(function() {
                            setInterval(function() {
                                    $('#likeOrDislikeDiv')
                                        .hide()
                                        .load('@Url.Action("ReloadLikeDislikePartial", "Home", new {Id = Model.NewsId})')
                                        .fadeIn(0.5);
                                    $('#likedislikeinfo')
                                        .hide()
                                        .load('@Url.Action("ReloadLikeDislikeInfo", "Home", new {Id = Model.NewsId})')
                                        .fadeIn(0.5);
                                    $('#commentDiv')
                                        .hide()
                                        .load('@Url.Action("ReloadPartialView", "Home", new {Id = Model.NewsId})')
                                        .fadeIn(0.5);
                                },
                                2000);
                        });
                        $('#commentMoreDiv').hide();
                    }
                });

            });


    </script>
}
</div>